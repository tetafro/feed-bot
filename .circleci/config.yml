version: 2
jobs:
  dep:
    docker:
      - image: circleci/golang:1.16
        environment:
          GO111MODULE: "on"
    working_directory: /go/src/github.com/tetafro/feed-bot
    steps:
      - checkout
      - run:
          name: Get project dependencies
          command: go mod download
      - save_cache:
          key: gomod-cache-{{ checksum "go.sum" }}
          paths:
            - /go/pkg
  test:
    docker:
      - image: circleci/golang:1.16
        environment:
          GO111MODULE: "on"
    working_directory: /go/src/github.com/tetafro/feed-bot
    steps:
      - checkout
      - restore_cache:
          keys:
            - gomod-cache-{{ checksum "go.sum" }}
      - run:
          name: Run tests
          command: go test -race ./...
  lint:
    docker:
      - image: circleci/golang:1.16
        environment:
          GO111MODULE: "on"
    working_directory: /go/src/github.com/tetafro/feed-bot
    steps:
      - checkout
      - restore_cache:
          keys:
            - gomod-cache-{{ checksum "go.sum" }}
      - run:
          name: Install linters
          command: go get -u github.com/golangci/golangci-lint/cmd/golangci-lint
      - run:
          name: Run linters
          command: golangci-lint run
  codecov:
    docker:
      - image: circleci/golang:1.16
        environment:
          GO111MODULE: "on"
    working_directory: /go/src/github.com/tetafro/feed-bot
    steps:
      - checkout
      - restore_cache:
          keys:
            - gomod-cache-{{ checksum "go.sum" }}
      - run: ./.circleci/codecov.sh
      - run: bash <(curl -s https://codecov.io/bash)
workflows:
  version: 2
  main:
    jobs:
      - dep
      - test:
          requires:
            - dep
      - lint:
          requires:
            - dep
      - codecov:
          requires:
            - dep
            - test
